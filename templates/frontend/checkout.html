{% extends "frontend/base.html" %}
{% load static %}

{% block content %}
<div class="container py-5">
    <div class="row justify-content-center">
        <div class="col-lg-10">
            <h2 class="mb-4 text-center fw-bold">Checkout</h2>

            <div class="row g-4">
                <!-- Cart Summary -->
                <div class="col-md-7">
                    <div class="card shadow-sm rounded-3">
                        <div class="card-header bg-dark text-white">
                            <h5 class="mb-0">üõí Your Order</h5>
                        </div>
                        <div class="card-body">
                            <div class="table-responsive">
                                <table class="table align-middle table-striped">
                                    <thead class="table-dark">
                                        <tr>
                                            <th>Product</th>
                                            <th>Qty</th>
                                            <th>Price</th>
                                            <th>Total</th>
                                        </tr>
                                    </thead>
                                    <tbody>
                                        {% for item in cart_items %}
                                        <tr>
                                            <td>{{ item.name }}</td>
                                            <td>{{ item.quantity }}</td>
                                            <td>‚Ç¶{{ item.price|floatformat:2 }}</td>
                                            <td>‚Ç¶{{ item.subtotal|floatformat:2 }}</td>
                                        </tr>
                                        {% empty %}
                                        <tr>
                                            <td colspan="4" class="text-center text-muted">No items in cart</td>
                                        </tr>
                                        {% endfor %}
                                    </tbody>
                                </table>
                            </div>
                            <hr>
                            <div class="d-flex justify-content-between">
                                <h5 class="mb-0">Total Quantity:</h5>
                                <h5 class="fw-bold">{{ cart_quantity_total }}</h5>
                            </div>
                            <div class="d-flex justify-content-between">
                                <h4 class="mb-0">Grand Total:</h4>
                                <h4 class="fw-bold text-success">‚Ç¶{{ cart_total|floatformat:2 }}</h4>
                            </div>
                        </div>
                    </div>
                </div>

                <!-- Checkout Form -->
                <div class="col-md-5">
                    <div class="card shadow-sm rounded-3">
                        <div class="card-header bg-success text-white">
                            <h5 class="mb-0">‚úî Confirm Details</h5>
                        </div>
                        <div class="card-body">
                            {% if cart_quantity_total >= 10 %}
                            <form id="whatsappCheckoutForm" class="needs-validation" novalidate>
                                <div class="mb-3">
                                    <label for="fullname" class="form-label fw-semibold">Full Name</label>
                                    <input type="text" id="fullname" class="form-control"
                                        placeholder="Enter your full name" required>
                                    <div class="invalid-feedback">Full name is required.</div>
                                </div>

                                <div class="mb-3">
                                    <label for="phone" class="form-label fw-semibold">Phone</label>
                                    <input type="text" id="phone" class="form-control" placeholder="e.g. +2348123456789"
                                        required>
                                    <div class="invalid-feedback">Phone number is required.</div>
                                </div>

                                <div class="mb-3">
                                    <label for="address" class="form-label fw-semibold">Address</label>
                                    <textarea id="address" rows="3" class="form-control"
                                        placeholder="Enter delivery address" required></textarea>
                                    <div class="invalid-feedback">Address is required.</div>
                                </div>

                                <button type="submit" class="btn btn-success w-100 py-2">
                                    <i class="bi bi-whatsapp"></i> Place Order via WhatsApp
                                </button>
                            </form>
                            {% else %}
                            <div class="alert alert-warning text-center mb-0">
                                ‚ö†Ô∏è You must order at least <strong>10 items</strong> before checkout.
                            </div>
                            {% endif %}
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>


{% if cart_quantity_total >= 10 %}
<script>
    document.getElementById("whatsappCheckoutForm").addEventListener("submit", function (e) {
        e.preventDefault();

        let fullname = document.getElementById("fullname").value;
        let phone = document.getElementById("phone").value;
        let address = document.getElementById("address").value;

        let orderDetails = encodeURIComponent(
            " *New Order* \n" +
            "Name: " + fullname + "\n" +
            " Phone: " + phone + "\n" +
            "Address: " + address + "\n\n" +
            "*Items Ordered:*\n"
        );

        {% for item in cart_items %}
        orderDetails += encodeURIComponent("- {{ item.name }} (x{{ item.quantity }}) - ‚Ç¶{{ item.subtotal }}\n");
        {% endfor %}

        orderDetails += encodeURIComponent("\n Total: ‚Ç¶{{ cart_total }}");


        // Your WhatsApp business number
        let whatsappNumber = "2347084448398";

        let whatsappUrl = "https://wa.me/" + whatsappNumber + "?text=" + orderDetails;
        window.open(whatsappUrl, "_blank");
    });
</script>
{% endif %}
{% endblock %}